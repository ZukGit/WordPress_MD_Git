var downloader=function(){function e(e){var r=e.bigUrl||e.originalUrl,a="jpg",l=e.alt,i=r.lastIndexOf("/"),o=r.substr(i+1,r.length);if((i=o.lastIndexOf("?"))>=0&&(o=o.substr(0,i)),(i=o.lastIndexOf("."))>=0&&(a=o.substr(i+1,o.length),o=o.substr(0,i)),o=o+"."+(a=("jpeg"==e.ext?"jpg":e.ext)||a),e.group&&(o=e.group+"-"+o),l&&(o=l+"."+a),n.needRename){var s;s=o.substring(0,o.lastIndexOf(".")||o.length),o=utils.replaceVarible({text:n.renameRule||n.defaultConfig.renameRule,index:e.selected?e.selectIndex:e.showIndex,ext:a,name:s,pageTitle:e.docTitle})}o.lastIndexOf(".")<0&&(o+=".jpg");var c=o;try{c=decodeURIComponent(o)}catch(e){}var u=(c=(c=(c=c.replace(/^ +/,"")).replace(/ +$/,"")).replace(/ /g,"_yythkg_")).replace(/[/~|\\:*?"'<>=%$@#+;,!\^\s]/g,"_").replace(/\.+$/g,"").split(".");u[0]=t(u[0].substr(0,100));var d=u=u.join(".");return"FIXED"==n.dirType?n.fixedDir&&(d=t(n.fixedDir)+"/"+u):e.docTitle&&(d=t(e.docTitle)+"/"+u),d=d.replace(/_yythkg_/g," ")}function t(e){return e=(e=(e=(e=(e=e.replace(/^ +/,"")).replace(/ +$/,"")).replace(/ /g,"_yythkg_")).replace(/[~|\\/:*?"'<>=%$@#+;,!\^\s]/g,"_").replace(/\.+$/g,"").substr(0,100)).replace(/_yythkg_/g," ")}function r(t){if(t){var r=t.bigUrl,a=t.blobUrl,l=e(t),o=a||r;n.autoConvertWebp&&t.jpgPngDataUrl&&(o=t.jpgPngDataUrl),"VIDEO"==t.type&&(o=t.originalUrl),chrome.downloads.download({url:o,filename:l,saveAs:!1,conflictAction:"uniquify"},function(n){if(n&&(i[n]=t),!n&&chrome.runtime.lastError&&chrome.runtime.lastError.message.match("Invalid filename")){var a=t.ref;a&&(a=(a=a.replace(/.*?:\/\//,"")).replace(/\?.*/,"")),a.match("/$")||(a+="/");var l=e({bigUrl:t.bigUrl,alt:t.showIndex+1+""});chrome.downloads.download({url:r,filename:a+l,saveAs:!1,conflictAction:"uniquify"},function(e){})}})}}chrome.downloads.onChanged.addListener(function(e){if(e.state&&n.limitConcurrent&&e.state.current.match("complete|interrupted")){var t=i[e.id];if(t&&(a(e.state.current,t),o<l.length)){var s=l[o];"started"!=downloader.status&&"resumed"!=downloader.status||(o++,r(s))}}});var n,a,l=[],i=[],o=0;return{status:"not-inited",init:function(e,t){n=e,a=t,o=0},download:function(e){l=e,o=0,l=e;for(var t=n.limitConcurrent||10,a=0;a<t&&a<l.length;a++)o++,r(l[a]);this.status="started"},downloadSingle:function(e){r(e)},stop:function(){this.status="stoped"},pause:function(){this.status="paused"},resume:function(){this.status="resumed";for(var e=0;e<n.limitConcurrent&&o<l.length;e++)r(l[o++])}}}();